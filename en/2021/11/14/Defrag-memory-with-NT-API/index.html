<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/en/../img/favicon.png"><link rel="icon" href="/en/../img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kenji Mouri"><meta name="keywords" content=""><meta name="description" content="The memory fragmentation is inevitable when the system is running, this can affect the system performance, so it is  necessary to defrag the memory at the proper time. Most of the memory defragmentati"><meta property="og:type" content="article"><meta property="og:title" content="Defrag memory with NT API"><meta property="og:url" content="https://mourinaruto.github.io/en/2021/11/14/Defrag-memory-with-NT-API/index.html"><meta property="og:site_name" content="Kenji Mouri"><meta property="og:description" content="The memory fragmentation is inevitable when the system is running, this can affect the system performance, so it is  necessary to defrag the memory at the proper time. Most of the memory defragmentati"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-11-14T04:03:41.000Z"><meta property="article:modified_time" content="2025-06-05T09:54:33.568Z"><meta property="article:author" content="Kenji Mouri"><meta property="article:tag" content="Technologies"><meta property="article:tag" content="Windows"><meta property="article:tag" content="Windows Research Notes"><meta property="article:tag" content="User Mode"><meta name="twitter:card" content="summary_large_image"><title>Defrag memory with NT API - Kenji Mouri</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/en/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.6.0/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_2188012_jkjop06z1g.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"mourinaruto.github.io",root:"/en/",version:"1.8.14",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:1280544492,leancloud:{app_id:"qEO7L1QVXqw752KnQk88IfDS-MdYXbMMI",app_key:"fEqb7CwIp1LJnuHKnhRlI2wh",server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/en/local-search.xml"}</script><script src="/en/js/utils.js"></script><script src="/en/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/en/"><strong>Kenji Mouri</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/en/"><i class="iconfont icon-home-fill"></i> Home</a></li><li class="nav-item"><a class="nav-link" href="/en/archives/"><i class="iconfont icon-archive-fill"></i> Archives</a></li><li class="nav-item"><a class="nav-link" href="/en/categories/"><i class="iconfont icon-category-fill"></i> Categories</a></li><li class="nav-item"><a class="nav-link" href="/en/tags/"><i class="iconfont icon-tags-fill"></i> Tags</a></li><li class="nav-item"><a class="nav-link" target="_blank" rel="noopener" href="https://github.com/MouriNaruto/MouriDocs"><i class="iconfont icon-book"></i> Docs</a></li><li class="nav-item"><a class="nav-link" href="https://mourinaruto.github.io/zh/"><i class="iconfont icon-book"></i> 中文</a></li><li class="nav-item"><a class="nav-link" href="/en/about/"><i class="iconfont icon-user-fill"></i> About</a></li><li class="nav-item"><a class="nav-link" href="/en/links/"><i class="iconfont icon-link-fill"></i> Links</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/en/../img/background.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="Defrag memory with NT API"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-11-14 04:03" pubdate>November 14, 2021 am</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.9k words </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 33 minutes</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">Defrag memory with NT API</h1><div class="markdown-body"><p>The memory fragmentation is inevitable when the system is running, this can affect the system performance, so it is necessary to defrag the memory at the proper time.</p><p>Most of the memory defragmentation tools on the market today achieve the goal through allocating as many memory blocks as possible from the system to squeeze as many memory blocks as possible into the swap file before releasing them. I do not think this is an elegant approach, because it requires that your tool must be running in Native mode instead of the WoW compatibility layer, for example, if your tool is 32-bit it can only request up to 4GB of memory from the system, which is not enough to achieve your goal. And since you are forcing the system to squeeze memory blocks into the swap file, it is not efficient and has a significant negative impact on the scheduling mechanism.</p><p>So, this article proposes a new way of memory defragmentation by calling the NT API to inform the kernel to move the memory blocks to the swap file automatically, so the process is very fast and has minimal impact on the scheduling mechanism.</p><p>Read <a target="_blank" rel="noopener" href="https://mouri.moe/zh/2021/11/14/Defrag-memory-with-NT-API/">here</a> for the Chinese version of this article if you are not good at English. (Translation: 如果你不擅长英文，可以点击本段话中的链接阅读中文版)</p><h2 id="Inspiration-source"><a href="#Inspiration-source" class="headerlink" title="Inspiration source"></a>Inspiration source</h2><p>When I used the features in the Empty menu from RAMMap tool in Sysinternals Suite, I found we can defrag memory efficiently with the proper operations.</p><p>So I used IDA Pro to analyze the features related to the RAMMap tool, and summarize my conclusions and write this article with examples.</p><h2 id="Operation-method"><a href="#Operation-method" class="headerlink" title="Operation method"></a>Operation method</h2><p>You need to run your binary as administrator.</p><p>First enable the SeProfileSingleProcessPrivilege privilege for the current process, then call NtSetSystemInformation and pass MemoryEmptyWorkingSets, MemoryFlushModifiedList and MemoryPurgeStandbyList to SystemMemoryListInformation to perform memory defragmentation.</p><h2 id="Code-example"><a href="#Code-example" class="headerlink" title="Code example"></a>Code example</h2><p>The following example rely on the NT API definitions from <a target="_blank" rel="noopener" href="https://github.com/Chuyu-Team/MINT">https://github.com/Chuyu-Team/MINT</a> created by myself.</p><figure class="highlight nsis"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></div></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-comment">#include &lt;MINT.h&gt;</span><br><br>namespace<br>&#123;<br>    static HRESULT DefragMemory()<br>    &#123;<br>        using NtSet<span class="hljs-params">System</span>InformationType = decltype(::NtSet<span class="hljs-params">System</span>Information)*<span class="hljs-comment">;</span><br>        using RtlNtStatusToDosErrorType = decltype(::RtlNtStatusToDosError)*<span class="hljs-comment">;</span><br><br>        NtSet<span class="hljs-params">System</span>InformationType pNtSet<span class="hljs-params">System</span>Information = nullptr<span class="hljs-comment">;</span><br>        RtlNtStatusToDosErrorType pRtlNtStatusToDosError = nullptr<span class="hljs-comment">;</span><br><br>        HMODULE ModuleHandle = ::GetModuleHandleW(L<span class="hljs-string">&quot;ntdll.dll&quot;</span>)<span class="hljs-comment">;</span><br>        if (!ModuleHandle)<br>        &#123;<br>            <span class="hljs-keyword">return</span> E_NOINTERFACE<span class="hljs-comment">;</span><br>        &#125;<br><br>        pNtSet<span class="hljs-params">System</span>Information = reinterpret_cast&lt;NtSet<span class="hljs-params">System</span>InformationType&gt;(<br>            ::GetProcAddress(ModuleHandle, <span class="hljs-string">&quot;NtSetSystemInformation&quot;</span>))<span class="hljs-comment">;</span><br>        if (!pNtSet<span class="hljs-params">System</span>Information)<br>        &#123;<br>            <span class="hljs-keyword">return</span> E_NOINTERFACE<span class="hljs-comment">;</span><br>        &#125;<br><br>        pRtlNtStatusToDosError = reinterpret_cast&lt;RtlNtStatusToDosErrorType&gt;(<br>            ::GetProcAddress(ModuleHandle, <span class="hljs-string">&quot;RtlNtStatusToDosError&quot;</span>))<span class="hljs-comment">;</span><br>        if (!pRtlNtStatusToDosError)<br>        &#123;<br>            <span class="hljs-keyword">return</span> E_NOINTERFACE<span class="hljs-comment">;</span><br>        &#125;<br><br>        // Working Sets -&gt; Modified <span class="hljs-keyword">Page</span> List -&gt; Standby List<br><br>        <span class="hljs-params">SYSTEM</span>_MEMORY_LIST_COMMAND CommandList[] =<br>        &#123;<br>            <span class="hljs-params">SYSTEM</span><span class="hljs-title function_">_MEMORY_LIST_COMMAND::MemoryEmptyWorkingSets</span>,<br>            <span class="hljs-params">SYSTEM</span><span class="hljs-title function_">_MEMORY_LIST_COMMAND::MemoryFlushModifiedList</span>,<br>            <span class="hljs-params">SYSTEM</span><span class="hljs-title function_">_MEMORY_LIST_COMMAND::MemoryPurgeStandbyList</span><br>        &#125;<span class="hljs-comment">;</span><br><br>        NTSTATUS Status = STATUS_SUCCESS<span class="hljs-comment">;</span><br><br>        for (size_t i = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; sizeof(CommandList) / sizeof(*CommandList); ++i)</span><br>        &#123;<br>            Status = pNtSet<span class="hljs-params">System</span>Information(<br>                <span class="hljs-params">System</span>MemoryListInformation,<br>                &amp;CommandList[i],<br>                sizeof(<span class="hljs-params">SYSTEM</span>_MEMORY_LIST_COMMAND))<span class="hljs-comment">;</span><br>            if (!NT_SUCCESS(Status))<br>            &#123;<br>                break<span class="hljs-comment">;</span><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">Mile::HResult</span>::FromWin32(pRtlNtStatusToDosError(Status))<span class="hljs-comment">;</span><br>    &#125;<br>&#125;<br><br>EXTERN_C HRESULT WINAPI MoDefragMemory(<br>    _In_ PNSUDO_CONTEXT Context)<br>&#123;<br>    <span class="hljs-title function_">Mile::HResult</span> hr = S_OK<span class="hljs-comment">;</span><br>    HANDLE CurrentProcessToken = INVALID_HANDLE_VALUE<span class="hljs-comment">;</span><br><br>    if (::OpenProcessToken(<br>        ::GetCurrentProcess(),<br>        MAXIMUM_ALLOWED,<br>        &amp;CurrentProcessToken))<br>    &#123;<br>        LUID_AND_ATTRIBUTES RawPrivilege<span class="hljs-comment">;</span><br>        RawPrivilege.Attributes = SE_PRIVILEGE_ENABLED<span class="hljs-comment">;</span><br>        if (::LookupPrivilegeValueW(<br>            nullptr,<br>            SE_PROF_SINGLE_PROCESS_NAME,<br>            &amp;RawPrivilege.Luid))<br>        &#123;<br>            hr = <span class="hljs-title function_">Mile::AdjustTokenPrivilegesSimple</span>(<br>                CurrentProcessToken,<br>                &amp;RawPrivilege,<br>                <span class="hljs-number">1</span>)<span class="hljs-comment">;</span><br>            if (hr.IsSucceeded())<br>            &#123;<br>                hr = ::DefragMemory()<span class="hljs-comment">;</span><br>            &#125;<br>        &#125;<br><br>        ::CloseHandle(CurrentProcessToken)<span class="hljs-comment">;</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> hr<span class="hljs-comment">;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="See-also"><a href="#See-also" class="headerlink" title="See also"></a>See also</h2><a href="/en/2021/11/02/Windows-Research-Notes/" title="Windows Research Notes">Windows Research Notes</a></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/en/categories/Technologies/">Technologies</a> <a class="hover-with-bg" href="/en/categories/Technologies/Windows/">Windows</a> <a class="hover-with-bg" href="/en/categories/Technologies/Windows/Windows-Research-Notes/">Windows Research Notes</a> <a class="hover-with-bg" href="/en/categories/Technologies/Windows/Windows-Research-Notes/User-Mode/">User Mode</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/en/tags/Technologies/">Technologies</a> <a class="hover-with-bg" href="/en/tags/Windows/">Windows</a> <a class="hover-with-bg" href="/en/tags/Windows-Research-Notes/">Windows Research Notes</a> <a class="hover-with-bg" href="/en/tags/User-Mode/">User Mode</a></div></div><p class="note note-warning">Unless otherwise stated, all articles in this blog follow the <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.en" rel="nofollow noopener noopener">CC BY-NC-ND 4.0 license</a>, please indicate the source for reprinting!</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/en/2021/11/23/Build-Qt-6-with-VC-LTL/"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Build Qt 6 with VC-LTL</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/en/2021/11/14/Using-System-Restore-via-CSharp/"><span class="hidden-mobile">Using System Restore via C#</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><script type="text/javascript">Fluid.utils.loadComments("#comments",(function(){var t=document.documentElement.getAttribute("data-user-color-scheme");t="dark"===t?"github-dark":"github-light",window.UtterancesThemeLight="github-light",window.UtterancesThemeDark="github-dark";var e=document.createElement("script");e.setAttribute("src","https://utteranc.es/client.js"),e.setAttribute("repo","MouriNaruto/MouriNaruto"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","blog"),e.setAttribute("theme",t),e.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(e)}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">Total number of visits: <span id="leancloud-site-pv"></span> </span><span id="leancloud-site-uv-container" style="display:none">Total number of visitors: <span id="leancloud-site-uv"></span></span></div><span id="cnzz_stat_icon_1280544492" style="display:none"></span></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/en/js/events.js"></script><script src="/en/js/plugins.js"></script><script src="/en/js/local-search.js"></script><script src="/en/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.2/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script defer src="/en/js/leancloud.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script defer src="//s4.cnzz.com/z_stat.php?id=1280544492&show=pic" type="text/javascript"></script><script src="/en/js/boot.js"></script></body></html>